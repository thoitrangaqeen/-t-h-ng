<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form ƒê·∫∑t H√†ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
        <h1 class="text-2xl font-bold text-center mb-6">Form ƒê·∫∑t H√†ng</h1>
        <form id="orderForm" class="space-y-4">
            <!-- S·∫£n ph·∫©m -->
            <div>
                <label class="block text-sm font-medium text-gray-700">S·∫£n ph·∫©m</label>
                <select id="product" name="product" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    <option value="" disabled selected>Ch·ªçn s·∫£n ph·∫©m</option>
                    <!-- C√°c option s·∫Ω ƒë∆∞·ª£c th√™m b·ªüi JavaScript -->
                </select>
            </div>

            <!-- Size -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Size</label>
                <select id="size" name="size" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    <option value="" disabled selected>Ch·ªçn size</option>
                    <option value="S">S</option>
                    <option value="M">M</option>
                    <option value="L">L</option>
                    <option value="XL">XL</option>
                    <option value="XXL">XXL</option>
                </select>
            </div>

            <!-- S·ªë l∆∞·ª£ng -->
            <div>
                <label class="block text-sm font-medium text-gray-700">S·ªë l∆∞·ª£ng</label>
                <input type="number" id="quantity" name="quantity" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
            </div>

            <!-- T√™n kh√°ch -->
            <div>
                <label class="block text-sm font-medium text-gray-700">T√™n kh√°ch</label>
                <input type="text" id="customername" name="customername" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
            </div>

            <!-- SƒêT -->
            <div>
                <label class="block text-sm font-medium text-gray-700">S·ªë ƒëi·ªán tho·∫°i</label>
                <input type="tel" id="phone" name="phone" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
            </div>

            <!-- ƒê·ªãa ch·ªâ -->
            <div>
                <label class="block text-sm font-medium text-gray-700">ƒê·ªãa ch·ªâ</label>
                <input type="text" id="address" name="address" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
            </div>

            <!-- Ghi ch√∫ -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Ghi ch√∫</label>
                <textarea id="notes" name="notes" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" rows="4"></textarea>
            </div>

            <!-- T·ªïng ti·ªÅn -->
            <div>
                <label class="block text-sm font-medium text-gray-700">T·ªïng ti·ªÅn</label>
                <input type="text" id="totalprice" name="totalprice" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Nh·∫≠p t·ªïng ti·ªÅn" required>
            </div>

            <!-- N√∫t g·ª≠i -->
            <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">G·ª≠i ƒê∆°n H√†ng</button>
        </form>
    </div>

    <script>
        // Thay b·∫±ng Web App URL c·ªßa b·∫°n
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyGo-pWiqP0L8bQC4qHmfdJBM8fYQuWfoWfPgklOUjNWkk23KIn42zFYF7nwI9qn6id-A/exec';
        // Telegram Bot API
        const telegramBotToken = '7626564277:AAHamCcfY86-jhqBukZW9wKXKuzWBXEo5jo';
        const telegramChatId = '7561438631';
        const telegramApiUrl = `https://api.telegram.org/bot${telegramBotToken}/sendMessage`;

        // Danh s√°ch s·∫£n ph·∫©m - c√≥ th·ªÉ th√™m/s·ª≠a/x√≥a d·ªÖ d√†ng
        let products = [
            "Qu·∫ßn ·ªëng r·ªông",
            "√Åo s∆° mi ch·∫•m bi",
            "SET v√†ng tr·∫Øng",
            "SET c·ªôc",
            "√ÅO linen",
            "√Åo tr·ªÖ vai",
            "Set denim"
        ];

        // H√†m ƒë·ªÉ th√™m s·∫£n ph·∫©m m·ªõi
        function addProduct(productName) {
            if (productName && !products.includes(productName)) {
                products.push(productName);
                updateProductSelect();
                console.log('ƒê√£ th√™m s·∫£n ph·∫©m:', productName);
            }
        }

        // H√†m ƒë·ªÉ x√≥a s·∫£n ph·∫©m
        function removeProduct(productName) {
            const index = products.indexOf(productName);
            if (index > -1) {
                products.splice(index, 1);
                updateProductSelect();
                console.log('ƒê√£ x√≥a s·∫£n ph·∫©m:', productName);
            }
        }

        // H√†m ƒë·ªÉ c·∫≠p nh·∫≠t select box
        function updateProductSelect() {
            const productSelect = document.getElementById("product");
            // L∆∞u gi√° tr·ªã hi·ªán t·∫°i
            const currentValue = productSelect.value;
            
            // X√≥a t·∫•t c·∫£ option c≈© (tr·ª´ option ƒë·∫ßu ti√™n)
            while (productSelect.children.length > 1) {
                productSelect.removeChild(productSelect.lastChild);
            }
            
            // Th√™m l·∫°i t·∫•t c·∫£ s·∫£n ph·∫©m
            products.forEach(product => {
                const option = document.createElement("option");
                option.value = product;
                option.textContent = product;
                productSelect.appendChild(option);
            });
            
            // Kh√¥i ph·ª•c gi√° tr·ªã ƒë√£ ch·ªçn n·∫øu c√≤n t·ªìn t·∫°i
            if (currentValue && products.includes(currentValue)) {
                productSelect.value = currentValue;
            }
        }

        // Kh·ªüi t·∫°o danh s√°ch s·∫£n ph·∫©m
        updateProductSelect();

        // ƒê·ªãnh d·∫°ng s·ªë ti·ªÅn
        function formatCurrency(value) {
            // Lo·∫°i b·ªè t·∫•t c·∫£ k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
            const numericValue = value.replace(/[^\d]/g, '');

            // N·∫øu kh√¥ng c√≥ s·ªë n√†o th√¨ return r·ªóng
            if (!numericValue) return '';

            // ƒê·ªãnh d·∫°ng s·ªë v·ªõi d·∫•u ch·∫•m ph√¢n c√°ch h√†ng ngh√¨n v√† th√™m VNƒê
            return parseInt(numericValue).toLocaleString('vi-VN') + ' VNƒê';
        }

        // X·ª≠ l√Ω ƒë·ªãnh d·∫°ng khi nh·∫≠p t·ªïng ti·ªÅn
        const totalPriceInput = document.getElementById("totalprice");
        totalPriceInput.addEventListener("input", function(e) {
            const cursorPosition = e.target.selectionStart;
            const oldValue = e.target.value;
            const newValue = formatCurrency(oldValue);

            e.target.value = newValue;

            // Gi·ªØ v·ªã tr√≠ con tr·ªè h·ª£p l√Ω
            const newCursorPosition = Math.min(cursorPosition, newValue.length - 4); // -4 ƒë·ªÉ tr√°nh v√†o ph·∫ßn " VNƒê"
            e.target.setSelectionRange(newCursorPosition, newCursorPosition);
        });

        // X·ª≠ l√Ω g·ª≠i form
        document.getElementById("orderForm").addEventListener("submit", function (e) {
            e.preventDefault();

            const form = document.getElementById("orderForm");
            const formData = new FormData(form);
            const formObject = Object.fromEntries(formData);

            // Th√™m th√¥ng tin v·ªÅ t√™n s·∫£n ph·∫©m ƒë·ªÉ x√°c ƒë·ªãnh sheet
            formData.append('productName', formObject.product);

            // G·ª≠i d·ªØ li·ªáu ƒë·∫øn Google Sheets
            fetch(scriptURL, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('L·ªói khi g·ª≠i ƒë·∫øn Google Sheets: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                if (data.result === 'success') {
                    // G·ª≠i th√¥ng b√°o qua Telegram
                    const message = `üì¶ *ƒê∆°n h√†ng m·ªõi*

*S·∫£n ph·∫©m:* ${formObject.product}
*Size:* ${formObject.size}
*S·ªë l∆∞·ª£ng:* ${formObject.quantity}
*T√™n kh√°ch:* ${formObject.customername}
*SƒêT:* ${formObject.phone}
*ƒê·ªãa ch·ªâ:* ${formObject.address}
*Ghi ch√∫:* ${formObject.notes || 'Kh√¥ng c√≥'}
*T·ªïng ti·ªÅn:* ${formObject.totalprice}
*Th·ªùi gian:* ${new Date().toLocaleString('vi-VN')}`;

                    return fetch(telegramApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: telegramChatId,
                            text: message,
                            parse_mode: 'Markdown'
                        })
                    });
                } else {
                    throw new Error('L·ªói t·ª´ Google Sheets: ' + data.error);
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('L·ªói khi g·ª≠i Telegram: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                if (data.ok) {
                    alert("ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c g·ª≠i, l∆∞u v√†o Google Sheets v√† th√¥ng b√°o qua Telegram!");
                    form.reset();
                } else {
                    throw new Error('L·ªói t·ª´ Telegram API: ' + data.description);
                }
            })
            .catch(error => {
                console.error('L·ªói:', error);
                alert("L·ªói: " + error.message);
            });
        });

        // Th√™m s·∫£n ph·∫©m m·ªõi (c√≥ th·ªÉ g·ªçi t·ª´ console ho·∫∑c th√™m button)
        // V√≠ d·ª•: addProduct("√Åo kho√°c m·ªõi");
        // V√≠ d·ª•: removeProduct("√Åo tr·ªÖ vai");
    </script>
</body>
</html>
